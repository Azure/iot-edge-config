steps:  
- task: AzureCLI@2
  inputs:
    azureSubscription: 'Connection to Pipeline resources for IoT Edge Config'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az account set -s "377c3343-75bb-4244-98a3-0fb84a830c4b"
      echo Get access token to subscription "Azure IoT DDE team subscription"
      armToken=$(az account get-access-token --resource https://apps.azureiotcentral.com -s ${subscription} | jq -r '.accessToken')
      echo Create API token to interact with Central app "https://e2etest-iotc-iiot-asset-app.azureiotcentral.com"
      curl -X PUT -d '{"roles":[{"role":"ca310b8d-2f4a-44e0-a36e-957c202cd8d4"}]}' -H "Content-Type:application/json" -H "Authorization:Bearer $armToken" https://e2etest-iotc-iiot-asset-app.azureiotcentral.com/api/preview/apiTokens/testtoken050521
      cd tests/e2e-tests
      chmod +x test-devicestate.sh
      ./test-devicestate.sh
        
- script: |
    cd tests/e2e-tests
    chmod +x test-azure-iot-edge-installer.sh
    ./test-azure-iot-edge-installer.sh  
  displayName: 'Run All E2E Tests'
